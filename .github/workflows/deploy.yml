name: Deploy Telegram Bot

# Required permissions for OIDC (if using AWS IAM roles)
permissions:
  id-token: write   # Required for AWS OIDC authentication
  contents: read    # Required to checkout repository

# Trigger workflow on push to master branch
on:
  push:
    branches: [ master ]
  # Allow manual workflow runs for testing
  workflow_dispatch:

# Environment variables used across all jobs
env:
  CI: true
  AWS_REGION: ${{ secrets.AWS_REGION }}
  PROJECT_NAME: telegram-notify-bot

jobs:
  notify-start:
    name: Notify Deployment Start
    uses: domengabrovsek/github-actions/.github/workflows/send-telegram-message.yml@master
    with:
      api_url: ${{ vars.TELEGRAM_API_URL }}
      chat_id: ${{ vars.TELEGRAM_CHAT_ID }}
      message: |
        ğŸš€ Telegram Bot Deployment Started

        ğŸ“¦ Project: telegram-notify-bot
        ğŸŒ¿ Branch: ${{ github.ref_name }}
        ğŸ‘¤ Triggered by: ${{ github.actor }}
        ğŸ“ Commit: ${{ github.event.head_commit.message }}

  deploy:
    name: Deploy to AWS
    needs: notify-start
    runs-on: ubuntu-latest

    steps:
    # Checkout repository code
    - name: Checkout
      uses: actions/checkout@v6

    # Setup Node.js using version from .nvmrc file (Node 24)
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version-file: .nvmrc
        cache: 'npm'

    # Install dependencies using npm ci for faster, reliable builds
    - name: Install dependencies
      run: npm ci --ignore-scripts --no-progress --audit=false

    # Build TypeScript code for Lambda deployment
    - name: Build application
      run: npm run build

    # Configure AWS credentials using IAM role or access keys
    - name: Setup AWS credentials
      uses: aws-actions/configure-aws-credentials@v5
      with:
        # Use IAM role if TERRAFORM_ROLE is set, otherwise fall back to access keys
        role-to-assume: ${{ secrets.TERRAFORM_ROLE }}
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # Setup OpenTofu CLI
    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: 1.9.0

    # Initialize OpenTofu backend and download providers
    # Create backend config dynamically from secrets and variables
    - name: Create Backend Config
      working-directory: ./terraform
      run: |
        cat > backend.hcl << EOF
        bucket = "${{ secrets.TERRAFORM_STATE_BUCKET }}"
        region = "${{ env.AWS_REGION }}"
        EOF

    - name: OpenTofu Init
      working-directory: ./terraform
      run: tofu init -backend-config=backend.hcl

    # Validate OpenTofu configuration files
    - name: OpenTofu Validate
      working-directory: ./terraform
      run: tofu validate

    # Plan infrastructure changes (preview what will be deployed)
    - name: OpenTofu Plan
      working-directory: ./terraform
      run: |
        tofu plan \
          -var="terraform_state_bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
          -var="project_name=${{ env.PROJECT_NAME }}" \
          -var="aws_region=${{ env.AWS_REGION }}"

    # Apply infrastructure changes
    - name: OpenTofu Apply
      working-directory: ./terraform
      run: |
        tofu apply -auto-approve \
          -var="terraform_state_bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
          -var="project_name=${{ env.PROJECT_NAME }}" \
          -var="aws_region=${{ env.AWS_REGION }}"

    # Extract webhook URL from OpenTofu outputs (masked for security)
    - name: Get webhook URL
      working-directory: ./terraform
      run: |
        WEBHOOK_URL=$(tofu output -raw api_gateway_invoke_url)
        echo "WEBHOOK_URL=$WEBHOOK_URL" >> $GITHUB_ENV
        echo "âœ… Webhook URL configured (masked for security)"

  # Send deployment success notification
  notify-success:
    name: Notify Deployment Success
    needs: deploy
    if: success()
    uses: domengabrovsek/github-actions/.github/workflows/send-telegram-message.yml@master
    with:
      api_url: ${{ vars.TELEGRAM_API_URL }}
      chat_id: ${{ vars.TELEGRAM_CHAT_ID }}
      message: |
        âœ… Telegram Bot Deployed Successfully!

        ğŸ“¦ Project: telegram-notify-bot
        ğŸŒ¿ Branch: ${{ github.ref_name }}
        ğŸ‘¤ Deployed by: ${{ github.actor }}
        ğŸ“ Commit: ${{ github.event.head_commit.message }}
        ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # Send deployment failure notification
  notify-failure:
    name: Notify Deployment Failure
    needs: deploy
    if: failure()
    uses: domengabrovsek/github-actions/.github/workflows/send-telegram-message.yml@master
    with:
      api_url: ${{ vars.TELEGRAM_API_URL }}
      chat_id: ${{ vars.TELEGRAM_CHAT_ID }}
      message: |
        âŒ Telegram Bot Deployment Failed!

        ğŸ“¦ Project: telegram-notify-bot
        ğŸŒ¿ Branch: ${{ github.ref_name }}
        ğŸ‘¤ Triggered by: ${{ github.actor }}
        ğŸ“ Commit: ${{ github.event.head_commit.message }}
        ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        âš ï¸ Check logs for details